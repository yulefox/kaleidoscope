# 日志分析

将所有日志统一格式并记录, 以供分析查询.

## 日志格式

```protobuf
message Event
{
    int64 id = 1;                       // ID (key)
    int64 pid = 2;                      // 父 ID
    int64 uid = 3;                      // 用户 ID
    int32 idx = 4;                      // 事件类型
    int32 oper = 5;                     // 操作事件源
    int32 arg_a = 8;                    // 32 位整型参数 A
    int32 arg_b = 9;                    // 32 位整型参数 B
    int64 arg_64 = 11;                  // 64 位整型参数
    string arg_str = 12;                // 字符串参数
    int32 status = 13;                  // 状态
    int32 createtime = 18;              // 创建时间
    int32 stamp = 19;                   // 更新时间
}
```

`Event` 对象编码为 `json` 格式.

## 日志收集

日志的记录有以下三种方案:

- 绝对解耦: 日志写入文件, 第三方将日志收集到处理中心.
- 轻度耦合: 日志直接写入消息队列, 由消息队列将日志发送到处理中心.
- 轻度耦合: 日志通过 grpc 写入交互服务, 由交互服务通过消息队列将日志发送到处理中心.

第一种方案对于日志记录者更加友好, 日志库爱用什么用什么, 只要最终写到文件即可. 但对日志收集模块来说, 需要完成以下工作:

- 定时收集日志文件, 上传到处理中心
- 实现日志增量收集, 避免重复和遗漏

第二种方案需要日志记录者使用指定的消息队列(`Kafka`, `NSQ`), 日志的收集工作由消息队列完成.

第三种方案与第二种方案相似, 区别在于需要日志记录者使用的 I/O 组件换成了 grpc, 消息队列由交互服务提供.

考虑第三方组件集成问题, 我们选择第三种方案.